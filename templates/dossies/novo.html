{% extends "base.html" %}

{% block title %}Novo Dossiê{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-folder-plus me-2"></i>
                Novo Dossiê
            </h1>
            <a href="{{ url_for('dossie.listar') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-folder-plus me-2"></i>
                    Cadastrar Novo Dossiê
                </h5>
            </div>
            <div class="card-header p-0">
                <ul class="nav nav-tabs card-header-tabs" id="dossieTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="informacoes-tab" data-bs-toggle="tab" data-bs-target="#informacoes" type="button" role="tab">
                            <i class="fas fa-info-circle me-2"></i>Informações do Dossiê
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="anexos-tab" data-bs-toggle="tab" data-bs-target="#anexos" type="button" role="tab">
                            <i class="fas fa-paperclip me-2"></i>Anexos
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="formNovoDossie" action="{{ url_for('dossie.novo') }}">
                    <div class="tab-content" id="dossieTabContent">
                        <!-- Aba Informações -->
                        <div class="tab-pane fade show active" id="informacoes" role="tabpanel">
                    <!-- Dados Básicos -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-info border-bottom pb-2">
                                <i class="fas fa-id-card me-2"></i>
                                Dados Básicos do Dossiê
                            </h6>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <label for="n_dossie" class="form-label">Número do Dossiê *</label>
                            <input type="text" class="form-control" id="n_dossie" name="n_dossie" required
                                   placeholder="Ex: 2024001" maxlength="50">
                        </div>
                        <div class="col-md-3">
                            <label for="ano" class="form-label">Ano *</label>
                            <input type="number" class="form-control" id="ano" name="ano" required
                                   min="1900" max="2030" placeholder="2024">
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="ativo" selected>Ativo</option>
                                <option value="arquivado">Arquivado</option>
                                <option value="transferido">Transferido</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Escola</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                                <i class="fas fa-school me-2 text-primary"></i>
                                <strong>{{ session.get('escola_nome', 'Escola do usuário') }}</strong>
                                <small class="text-muted d-block">Definida automaticamente</small>
                            </div>
                        </div>
                    </div>

                    <!-- Dados do Aluno -->
                    <div class="row mb-4 mt-4">
                        <div class="col-12">
                            <h6 class="text-info border-bottom pb-2">
                                <i class="fas fa-user-graduate me-2"></i>
                                Dados do Aluno
                            </h6>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <label for="nome" class="form-label">Nome Completo do Aluno *</label>
                            <input type="text" class="form-control" id="nome" name="nome" required
                                   placeholder="Nome completo do aluno" maxlength="200">
                        </div>
                        <div class="col-md-4">
                            <label for="cpf" class="form-label">CPF do Aluno</label>
                            <input type="text" class="form-control" id="cpf" name="cpf"
                                   placeholder="000.000.000-00" maxlength="14">
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="n_mae" class="form-label">Nome da Mãe</label>
                            <input type="text" class="form-control" id="n_mae" name="n_mae"
                                   placeholder="Nome completo da mãe" maxlength="200">
                        </div>
                        <div class="col-md-6">
                            <label for="n_pai" class="form-label">Nome do Pai</label>
                            <input type="text" class="form-control" id="n_pai" name="n_pai"
                                   placeholder="Nome completo do pai" maxlength="200">
                        </div>
                    </div>

                    <!-- Localização e Documentos -->
                    <div class="row mb-4 mt-4">
                        <div class="col-12">
                            <h6 class="text-info border-bottom pb-2">
                                <i class="fas fa-archive me-2"></i>
                                Localização e Documentos
                            </h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <label for="local" class="form-label">Local Físico</label>
                            <input type="text" class="form-control" id="local" name="local"
                                   placeholder="Ex: Arquivo Central, Sala 10" maxlength="100">
                        </div>
                        <div class="col-md-4">
                            <label for="pasta" class="form-label">Número da Pasta</label>
                            <input type="text" class="form-control" id="pasta" name="pasta"
                                   placeholder="Ex: P001, Pasta-2024-01" maxlength="50">
                        </div>
                        <div class="col-md-4">
                            <label for="tipo_documento" class="form-label">Tipo de Documento</label>
                            <select class="form-select" id="tipo_documento" name="tipo_documento">
                                <option value="">Selecione...</option>
                                <option value="Histórico Escolar">Histórico Escolar</option>
                                <option value="Certificado">Certificado</option>
                                <option value="Diploma">Diploma</option>
                                <option value="Boletim">Boletim</option>
                                <option value="Documentos Pessoais">Documentos Pessoais</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                    </div>

                    <!-- Foto e Observações -->
                    <div class="row mb-4 mt-4">
                        <div class="col-12">
                            <h6 class="text-info border-bottom pb-2">
                                <i class="fas fa-camera me-2"></i>
                                Foto e Observações
                            </h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 text-center">
                            <img id="previewFotoAluno"
                                 src="/static/img/default-student.svg"
                                 alt="Foto do aluno"
                                 class="rounded-circle img-thumbnail mb-3"
                                 style="width: 120px; height: 120px; object-fit: cover; cursor: pointer;"
                                 onclick="document.getElementById('foto').click()">

                            <div>
                                <input type="file"
                                       id="foto"
                                       name="foto"
                                       accept="image/*"
                                       style="display: none;"
                                       onchange="previewImageAluno(this)">

                                <button type="button"
                                        class="btn btn-outline-primary btn-sm me-2"
                                        onclick="document.getElementById('foto').click()">
                                    <i class="fas fa-camera me-1"></i>Selecionar
                                </button>

                                <button type="button"
                                        class="btn btn-outline-secondary btn-sm"
                                        onclick="removePreviewAluno()"
                                        id="btnRemoverFotoAluno"
                                        style="display: none;">
                                    <i class="fas fa-trash me-1"></i>Remover
                                </button>
                            </div>

                            <small class="text-muted d-block mt-2">
                                JPG, PNG, GIF<br>
                                Máx: 5MB
                            </small>
                        </div>
                        <div class="col-md-9">
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Dica:</strong> A foto digital facilita a identificação do aluno no sistema e aparecerá em todos os relatórios e consultas.
                            </div>
                            <div class="alert alert-warning">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Importante:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>A foto será redimensionada automaticamente</li>
                                    <li>Formatos aceitos: JPG, PNG, GIF, WEBP</li>
                                    <li>Tamanho máximo: 5MB</li>
                                    <li>Recomendado: foto 3x4 ou similar</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="observacao" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacao" name="observacao" rows="4"
                                      placeholder="Observações gerais sobre o dossiê, documentos especiais, etc."></textarea>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Importante:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>O número do dossiê deve ser único no sistema</li>
                                    <li>Verifique se todos os dados estão corretos antes de salvar</li>
                                    <li>A localização física ajuda na organização do arquivo</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary" id="btnSalvar">
                                <i class="fas fa-save me-2"></i>
                                Salvar Dossiê
                            </button>
                        </div>
                    </div>

                        </div>

                        <!-- Aba Anexos -->
                        <div class="tab-pane fade" id="anexos" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Informação:</strong> Você pode adicionar documentos e anexos ao dossiê.
                                    </div>
                                </div>
                            </div>

                            <!-- Lista de Anexos -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="tabelaAnexos">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Nome do Arquivo</th>
                                                    <th>Nome Personalizado</th>
                                                    <th>Tamanho</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Anexos serão adicionados aqui via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Formulário de Upload -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="anexos_files" class="form-label">Selecionar Arquivos</label>
                                        <input type="file" class="form-control" id="anexos_files" multiple
                                               accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                                        <small class="text-muted">
                                            Formatos aceitos: PDF, DOC, DOCX, XLS, XLSX, JPG, JPEG, PNG<br>
                                            Tamanho máximo por arquivo: 10MB
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="anexo_nome" class="form-label">Nome Personalizado (opcional)</label>
                                        <input type="text" class="form-control" id="anexo_nome"
                                               placeholder="Ex: Histórico Escolar 2024">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Importante:</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Verifique se os arquivos estão legíveis antes de enviar</li>
                                            <li>Use nomes personalizados para facilitar a identificação</li>
                                            <li>O tamanho total dos anexos não deve exceder 50MB</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Função para adicionar mais campos de anexo
    function adicionarCampoAnexo() {
        const container = document.getElementById('anexosContainer');
        const novoAnexo = document.createElement('div');
        novoAnexo.className = 'anexo-item mb-3 p-3 border rounded';
        novoAnexo.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Arquivo</label>
                    <input type="file" class="form-control" name="anexos_files[]" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.txt,.zip,.rar">
                </div>
                <div class="col-md-5">
                    <label class="form-label">Nome/Descrição *</label>
                    <input type="text" class="form-control" name="anexos_nomes[]" placeholder="Ex: Histórico Escolar, Certificado..." required>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removerCampoAnexo(this)" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(novoAnexo);
    }

    function removerCampoAnexo(button) {
        button.closest('.anexo-item').remove();
    }

    // Inicializar abas Bootstrap
    document.addEventListener('DOMContentLoaded', function() {
        // Ativar abas Bootstrap
        var triggerTabList = [].slice.call(document.querySelectorAll('#dossieTab button'))
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)

            triggerEl.addEventListener('click', function (event) {
                event.preventDefault()
                tabTrigger.show()
            })
        })
    })
    // Máscara para CPF
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = value;
        });
    }

    // Auto-gerar número do dossiê baseado no ano
    const anoInput = document.getElementById('ano');
    const nDossieInput = document.getElementById('n_dossie');
    if (anoInput && nDossieInput) {
        anoInput.addEventListener('change', function() {
            const ano = this.value;

            if (ano && !nDossieInput.value) {
                // Gerar número sequencial baseado no ano
                const numeroSugerido = ano + '001';
                nDossieInput.value = numeroSugerido;
            }
        });
    }

    // Validação do formulário
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('formNovoDossie');
        const btnSalvar = document.getElementById('btnSalvar');
        const tabelaAnexos = document.getElementById('tabelaAnexos').getElementsByTagName('tbody')[0];
        const inputAnexos = document.getElementById('anexos_files');
        const inputNomePersonalizado = document.getElementById('anexo_nome');
        let anexos = [];

        // Função para formatar tamanho do arquivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Função para adicionar anexo à tabela
        function adicionarAnexo(file, nomePersonalizado = '') {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${file.name}</td>
                <td>${nomePersonalizado || '-'}</td>
                <td>${formatFileSize(file.size)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removerAnexo(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tabelaAnexos.appendChild(tr);

            // Adicionar ao array de anexos
            anexos.push({
                file: file,
                nomePersonalizado: nomePersonalizado
            });

            // Limpar inputs
            inputAnexos.value = '';
            inputNomePersonalizado.value = '';
        }

        // Evento de mudança no input de arquivos
        inputAnexos.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const nomePersonalizado = inputNomePersonalizado.value.trim();

            files.forEach(file => {
                // Verificar tamanho do arquivo (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`O arquivo ${file.name} excede o tamanho máximo permitido de 10MB.`);
                    return;
                }

                // Verificar tipo do arquivo
                const tiposPermitidos = [
                    'application/pdf',
                    'application/msword',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    'application/vnd.ms-excel',
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'image/jpeg',
                    'image/png'
                ];

                if (!tiposPermitidos.includes(file.type)) {
                    alert(`O arquivo ${file.name} não é de um tipo permitido.`);
                    return;
                }

                adicionarAnexo(file, nomePersonalizado);
            });
        });

        // Função para remover anexo
        window.removerAnexo = function(button) {
            const tr = button.closest('tr');
            const index = Array.from(tabelaAnexos.children).indexOf(tr);
            anexos.splice(index, 1);
            tr.remove();
        };

        // Evento de submit do formulário
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Desabilitar botão de salvar
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            
            // Validar campos obrigatórios
            const n_dossie = document.getElementById('n_dossie').value.trim();
            const nome = document.getElementById('nome').value.trim();
            const ano = document.getElementById('ano').value.trim();
            
            if (!n_dossie || !nome || !ano) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Dossiê';
                return;
            }
            
            // Validar CPF se preenchido
            const cpf = document.getElementById('cpf').value.trim();
            if (cpf && !validarCPF(cpf)) {
                alert('CPF inválido. Por favor, verifique.');
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Dossiê';
                return;
            }

            // Adicionar anexos ao FormData
            const formData = new FormData(form);
            anexos.forEach((anexo, index) => {
                formData.append('anexos_files[]', anexo.file);
                formData.append('anexos_nomes[]', anexo.nomePersonalizado);
            });
            
            // Enviar formulário
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else if (response.ok) {
                    window.location.href = "{{ url_for('dossie.listar') }}";
                } else {
                    throw new Error('Erro ao salvar dossiê');
                }
            })
            .catch(error => {
                alert('Erro ao salvar dossiê: ' + error.message);
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Dossiê';
            });
        });
        
        // Função para validar CPF
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]/g, '');
            
            if (cpf.length !== 11) return false;
            
            // Verifica se todos os dígitos são iguais
            if (/^(\d)\1{10}$/.test(cpf)) return false;
            
            // Validação do primeiro dígito verificador
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = 11 - (soma % 11);
            let digitoVerificador1 = resto > 9 ? 0 : resto;
            
            if (digitoVerificador1 !== parseInt(cpf.charAt(9))) return false;
            
            // Validação do segundo dígito verificador
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = 11 - (soma % 11);
            let digitoVerificador2 = resto > 9 ? 0 : resto;
            
            return digitoVerificador2 === parseInt(cpf.charAt(10));
        }
        
        // Função para formatar CPF
        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 9) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/(\d{3})(\d{3})/, '$1.$2');
            }
            
            e.target.value = value;
        });
        
        // Função para preview da foto
        function previewImageAluno(input) {
            const preview = document.getElementById('previewFotoAluno');
            const btnRemover = document.getElementById('btnRemoverFotoAluno');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    btnRemover.style.display = 'inline-block';
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Função para remover preview da foto
        function removePreviewAluno() {
            const preview = document.getElementById('previewFotoAluno');
            const input = document.getElementById('foto');
            const btnRemover = document.getElementById('btnRemoverFotoAluno');
            
            preview.src = '/static/img/default-student.svg';
            input.value = '';
            btnRemover.style.display = 'none';
        }
    });
</script>
{% endblock %}
